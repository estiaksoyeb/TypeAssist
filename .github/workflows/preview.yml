name: Preview Build & Deploy

permissions:
  contents: write
  pages: write
  id-token: write

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      commit_count: ${{ steps.set_commit.outputs.commit_count }}
      build_time: ${{ steps.set_commit.outputs.build_time }}
      universal_size: ${{ steps.set_commit.outputs.universal_size }}
      arm64-v8a_size: ${{ steps.set_commit.outputs.arm64-v8a_size }}
      armeabi-v7a_size: ${{ steps.set_commit.outputs.armeabi-v7a_size }}
      x86_size: ${{ steps.set_commit.outputs.x86_size }}
      x86_64_size: ${{ steps.set_commit.outputs.x86_64_size }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'adopt'
          java-version: 17
          cache: 'gradle'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew assembleRelease

      - name: Sign APK
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY_BASE64 }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "35.0.0"

      - name: Copy build artifacts
        id: set_commit
        run: |
          set -e
          commit_count=$(git rev-list --count HEAD)
          build_time=$(date -u +"%Y-%m-%d %H:%M UTC")
          echo "commit_count=$commit_count" >> $GITHUB_OUTPUT
          echo "build_time=$build_time" >> $GITHUB_OUTPUT

          mkdir -p output
          src="app/build/outputs/apk/release/app-release-signed.apk"
          dest="output/TypeAssist-preview-r${commit_count}.apk"
          cp "$src" "$dest"
          
          size=$(du -h "$dest" | cut -f1)
          echo "universal_size=$size" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-apk
          path: output/

  publish:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: preview-apk
          path: ./public

      - name: Generate download page
        run: |
          commit_count=${{ needs.build.outputs.commit_count }}
          build_time="${{ needs.build.outputs.build_time }}"
          echo "<!DOCTYPE html>
          <html lang='en'>
          <head>
            <meta charset='UTF-8'>
            <meta name='viewport' content='width=device-width, initial-scale=1.0'>
            <title>TypeAssist Preview Builds</title>
            <style>
              body { font-family: sans-serif; padding: 2em; background: #0d1117; color: #c9d1d9; }
              h1 { color: #58a6ff; }
              a { color: #58a6ff; text-decoration: none; display: block; margin: 8px 0; }
              a:hover { text-decoration: underline; }
              .note { color: #8b949e; font-size: 0.9em; margin-top: 1em; }
            </style>
          </head>
          <body>
            <h1>TypeAssist Preview Build r${commit_count}</h1>
            <p>Build time: ${build_time}</p>
            <p>Download the latest signed APK:</p>
            <ul>
              <li><a href='TypeAssist-preview-r${commit_count}.apk'>Download APK (${{ needs.build.outputs.universal_size }})</a></li>
            </ul>
            <p class='note'>Built automatically from the <code>master</code> branch.</p>
          </body>
          </html>" > ./public/index.html

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  deploy:
    needs: publish
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4